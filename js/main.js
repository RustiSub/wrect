var wrect = {};
var game;

window.onload = function() {

  var loader = new PIXI.AssetLoader([
    'resources/gui/maximize.png'
  ]);
  loader.load();
  loader.addEventListener('onComplete', function() {
    game = new Game({
      debug: true,
      width: window.innerWidth,
      height: window.innerHeight,
      defaultLevel: false
    });

    wrect.getGame = function() {
      return game;
    };

    game.timeStepSystem = new wrect.ECS.System.TimeStep();

    game.systems = {
      Gravity: {
        system: new wrect.ECS.System.Gravity()
      },
      QuadTree: {
        system: new wrect.ECS.System.QuadTree()
      },
      Mover: {
        system: new wrect.ECS.System.Mover()
      },
      Collision: {
        system: new wrect.ECS.System.Collision()
      }
    };

    function createBlock(options) {
      options = options || {
        x: 300,
        y: 100,
        w: 100,
        h: 40,
        color: 0xFFFFFF
      };
      var block = new wrect.ECS.Assemblage.Block(options);

      game.getEntityManager().addEntity(block);

      return block;
    }

    createBlock({
      x: 50,
      y: 500,
      w: 700,
      h: 5,
      color: 0xFFFFFF
    });

    //var block = createBlock({
    //  x: 200,
    //  y: 50,
    //  w: 20,
    //  h: 50,
    //  color: 0xFFFFFF
    //});


    //block.components.RigidBody.physicsBody.a = new wrect.Physics.Vector(0, 9.81);
    //block.components.RigidBody.frozen = false;

    for (var l= 0; l < 1; l++) {
      for (var t= 0; t < 5; t++) {
        var block = createBlock({
          x: 200 + (t * (50 + 60)) ,
          y: 10 + l * (10 + 1) + (50 * t),
          w: 40,
          h: 100,
          color: 0xFFFFFF
        });
        block.components.RigidBody.gravity = true;
        block.components.RigidBody.frozen = false;
      }
    }
    //block.components.RigidBody.physicsBody.a = block.components.RigidBody.physicsBody.a.add(new wrect.Physics.Vector(10, 0));
    block.components.RigidBody.gravity = true;
    block.components.RigidBody.frozen = false;

    // TileMap stuff
    var parser = new wrect.TileMap.Parser();
    parser.loadTilemap('resources/levels/tilemap/tiled.json');
/*
    var tileData = [2, 34, 2, 18, 17, 17, 17, 33, 1, 17, 18, 17, 1, 1, 1, 1, 1, 17, 34, 2, 17, 33, 2, 33, 17, 34, 34, 17, 17, 1, 1, 17, 17, 18, 33, 18, 2, 1, 17, 2, 34, 2, 2, 34, 18, 33, 17, 1, 33, 34, 1, 33, 33, 34, 17, 17, 33, 1, 34, 2, 33, 34, 139, 140, 141, 140, 141, 1, 2, 2, 1, 1, 17, 33, 34, 18, 33, 2, 18, 2, 34, 2, 34, 34, 34, 1, 18, 17, 2, 1, 1, 1, 18, 18, 2, 2, 33, 34, 33, 17, 18, 34, 2, 1, 1, 18, 2, 17, 33, 1, 33, 2, 155, 156, 156, 156, 157, 2, 1, 33, 1, 2, 1, 2, 18, 34, 1, 33, 2, 3221225509, 1610612757, 1610612757, 2684354585, 1610612773, 2684354563, 34, 33, 1, 17, 18, 17, 1, 18, 2, 17, 2, 18, 18, 18, 34, 33, 18, 2, 17, 33, 33, 3, 4, 5, 51, 3221225509, 1610612773, 171, 172, 156, 156, 173, 34, 34, 17, 1, 33, 1, 17, 33, 2, 17, 18, 17, 2684354597, 1610612738, 1610612756, 1610612756, 1610612772, 34, 17, 18, 1, 18, 2, 1, 33, 2, 34, 33, 17, 17, 2, 33, 18, 17, 18, 2, 34, 18, 34, 19, 20, 20, 5, 2, 21, 2, 1, 1, 1, 18, 17, 34, 18, 1, 17, 33, 18, 1, 34, 17, 34, 2, 1610612787, 1610612741, 1610612756, 1610612756, 1610612772, 33, 17, 34, 2, 1, 33, 1, 2, 1, 18, 2, 34, 33, 17, 34, 2, 34, 18, 34, 17, 2, 34, 35, 20, 20, 20, 20, 21, 18, 33, 33, 17, 17, 17, 17, 18, 18, 33, 33, 34, 2, 33, 2, 1, 34, 1610612741, 1610612756, 1610612756, 1610612756, 1610612772, 6, 7, 7, 7, 8, 17, 18, 33, 33, 2, 2, 1, 18, 17, 34, 1, 2, 18, 1, 18, 1, 2, 3221225509, 20, 20, 20, 20, 3221225497, 17, 18, 17, 17, 17, 1, 10, 2684354586, 2684354586, 2684354570, 17, 18, 17, 33, 34, 18, 1, 1610612740, 1610612756, 1610612756, 1610612756, 1610612772, 22, 23, 23, 23, 24, 33, 33, 17, 33, 17, 17, 18, 34, 2, 34, 34, 2, 1, 18, 17, 18, 2, 2684354597, 36, 36, 36, 36, 37, 2, 33, 33, 33, 17, 1, 26, 27, 27, 3221225498, 34, 2, 17, 2, 33, 34, 17, 1610612739, 1610612755, 1610612771, 2684354597, 37, 22, 1610612759, 1610612759, 23, 24, 2, 18, 18, 33, 2, 18, 18, 33, 18, 17, 17, 2, 33, 17, 1, 34, 34, 1610612739, 2, 34, 17, 17, 3221225475, 34, 33, 18, 2, 1, 18, 26, 27, 27, 3221225498, 1, 1, 33, 2, 2, 18, 2, 2, 1, 17, 17, 33, 22, 3221225495, 3221225495, 3221225495, 24, 1, 2, 33, 33, 1, 34, 17, 17, 18, 18, 1, 18, 17, 17, 1, 2, 33, 2, 1, 34, 17, 17, 34, 17, 2, 34, 33, 33, 18, 26, 27, 27, 3221225498, 1, 2, 1, 17, 34, 34, 1, 33, 1, 34, 2, 18, 38, 39, 39, 39, 40, 1, 18, 33, 34, 17, 17, 2, 33, 2, 1, 33, 18, 1, 2, 33, 2, 33, 18, 18, 33, 2, 34, 1, 2, 2, 18, 34, 34, 2, 26, 27, 27, 3221225498, 17, 17, 1, 34, 2, 17, 34, 1, 1, 18, 1, 1, 33, 17, 34, 33, 2, 33, 18, 2, 33, 17, 18, 34, 34, 33, 17, 34, 2, 2, 1, 33, 34, 34, 18, 2, 2, 17, 1, 1, 34, 2, 34, 18, 1, 33, 26, 27, 27, 3221225498, 18, 34, 34, 34, 18, 1, 18, 2, 33, 34, 34, 18, 33, 2, 33, 1, 33, 2, 17, 33, 1, 17, 33, 34, 2, 1, 33, 33, 2, 2, 1, 34, 18, 2, 33, 34, 18, 1, 34, 34, 17, 17, 17, 33, 33, 1, 26, 27, 27, 3221225498, 2, 18, 17, 17, 18, 18, 33, 17, 18, 1, 18, 1, 33, 34, 17, 17, 33, 2, 34, 17, 17, 34, 17, 17, 34, 18, 2, 34, 18, 18, 18, 18, 34, 2, 2, 34, 33, 1, 33, 2, 34, 34, 34, 33, 17, 1, 26, 27, 27, 3221225498, 34, 33, 2, 17, 18, 18, 17, 2, 17, 18, 34, 33, 18, 1, 18, 18, 2, 34, 1, 17, 34, 33, 33, 17, 1, 18, 18, 1, 33, 18, 34, 34, 17, 17, 1, 33, 18, 34, 34, 1, 17, 1, 18, 2, 18, 34, 26, 27, 27, 3221225498, 18, 18, 33, 34, 2, 33, 34, 17, 34, 34, 18, 1, 1, 1, 17, 1, 33, 1, 2, 34, 2, 2, 2, 17, 18, 33, 1, 34, 1, 1, 1, 1, 18, 1, 17, 33, 18, 2, 18, 1, 17, 2, 17, 1, 34, 18, 26, 27, 27, 3221225498, 1, 2, 17, 17, 2, 2, 33, 1, 34, 33, 34, 2, 2, 34, 1, 33, 18, 34, 18, 33, 34, 17, 18, 17, 18, 2, 1, 1, 18, 34, 17, 17, 34, 33, 33, 2, 33, 34, 18, 33, 1, 17, 17, 1, 18, 18, 26, 27, 27, 3221225498, 34, 18, 34, 34, 1, 1, 2, 1, 34, 2, 18, 34, 34, 33, 1, 2, 17, 2, 34, 34, 18, 18, 2, 33, 17, 17, 2, 33, 17, 17, 1, 1, 2, 34, 17, 2, 2, 33, 17, 1, 1, 17, 17, 1, 33, 18, 26, 27, 27, 3221225498, 2, 34, 33, 1, 33, 18, 34, 33, 18, 34, 33, 18, 1, 34, 33, 33, 34, 33, 18, 33, 34, 34, 18, 1, 17, 1, 18, 1, 18, 18, 18, 2, 1, 34, 1, 1, 2, 34, 34, 18, 17, 33, 1, 33, 33, 18, 26, 27, 27, 3221225498, 17, 34, 33, 18, 34, 2, 1, 34, 34, 34, 18, 17, 17, 17, 33, 17, 17, 1, 1, 17, 18, 2, 18, 34, 2, 34, 17, 1, 1, 33, 1, 1, 17, 34, 2, 17, 33, 17, 1, 2, 18, 34, 2, 34, 2, 18, 26, 27, 27, 3221225498, 17, 1, 18, 17, 33, 1, 1, 18, 18, 18, 34, 2, 17, 18, 33, 34, 18, 17, 18, 18, 1, 17, 33, 18, 17, 17, 17, 1, 18, 2, 2, 1, 2, 34, 33, 1, 18, 33, 34, 2, 18, 17, 1, 33, 34, 2, 26, 27, 27, 3221225498, 18, 18, 17, 2, 34, 34, 33, 2, 18, 34, 17, 34, 34, 1, 18, 18, 18, 34, 33, 1, 17, 17, 34, 1, 17, 2, 33, 2, 17, 17, 2, 2, 33, 2, 1, 17, 34, 34, 18, 33, 1, 18, 2, 17, 18, 33, 26, 27, 27, 3221225498, 1, 34, 33, 33, 34, 34, 33, 34, 34, 1, 18, 17, 34, 1, 17, 2, 33, 17, 17, 33, 2, 18, 33, 34, 34, 1, 34, 1, 33, 17, 34, 2, 34, 33, 18, 33, 1, 18, 33, 18, 33, 2, 17, 17, 1, 17, 26, 27, 27, 3221225498, 17, 2, 17, 17, 33, 18, 17, 33, 34, 2, 33, 34, 18, 17, 17, 18, 1, 2, 18, 17, 33, 33, 34, 33, 1, 17, 2, 34, 2, 17, 33, 33, 33, 1, 34, 18, 17, 17, 2, 34, 33, 18, 2, 33, 33, 33, 26, 27, 27, 3221225498, 18, 17, 34, 34, 2, 34, 33, 1, 1, 33, 17, 17, 1, 33, 2, 18, 33, 17, 18, 1, 2, 18, 18, 1, 18, 1, 33, 1, 34, 33, 2, 33, 34, 2, 18, 2, 34, 1, 34, 18, 2, 2, 1, 18, 1, 18, 26, 27, 27, 3221225498, 18, 17, 34, 33, 1, 33, 2, 1, 2, 2, 2, 33, 17, 33, 33, 18, 33, 34, 34, 34, 33, 17, 33, 34, 34, 1, 33, 17, 33, 33, 34, 33, 34, 33, 34, 2, 2, 33, 18, 34, 18, 18, 1, 17, 33, 1, 26, 27, 27, 3221225498, 2, 33, 2, 17, 33, 17, 1, 1, 34, 1, 18, 1, 1, 2, 2, 18, 34, 34, 1, 2, 17, 34, 17, 17, 18, 33, 34, 18, 34, 33, 33, 17, 18, 33, 1, 33, 18, 17, 34, 2, 18, 33, 18, 2, 17, 18, 26, 27, 27, 3221225498, 18, 17, 33, 2, 33, 1, 1, 2, 33, 2, 34, 18, 1, 17, 2, 33, 34, 17, 18, 33, 2, 18, 1, 18, 18, 18, 33, 33, 2, 2, 2, 18, 17, 2, 33, 17, 34, 1, 17, 1, 17, 34, 34, 18, 2, 17, 26, 27, 27, 3221225498, 2, 1, 17, 34, 34, 18, 17, 34, 34, 17, 33, 2, 34, 33, 18, 18, 34, 18, 1, 2, 33, 2, 1, 33, 17, 1, 2, 33, 34, 34, 34, 2, 2, 33, 33, 1, 1, 1, 33, 33, 1, 1, 18, 33, 18, 33, 26, 27, 27, 3221225498, 34, 1, 34, 33, 33, 18, 17, 33, 33, 18, 3221225509, 1610612757, 1610612757, 2684354585, 1610612773, 2684354563, 17, 18, 17, 33, 2, 34, 33, 33, 18, 2, 2, 18, 33, 1, 1, 33, 2, 34, 33, 18, 17, 18, 34, 18, 34, 17, 33, 17, 18, 1, 26, 27, 27, 3221225498, 17, 2, 34, 33, 34, 17, 17, 1, 2, 17, 2684354597, 1610612738, 1610612756, 1610612756, 1610612772, 2, 34, 2, 2, 2, 1, 33, 2, 2, 1, 33, 1, 33, 2, 1, 33, 33, 33, 33, 34, 18, 34, 2, 1, 18, 33, 33, 1, 18, 2, 18, 26, 27, 27, 3221225498, 33, 17, 34, 34, 17, 33, 2, 18, 17, 34, 1610612787, 1610612741, 1610612756, 1610612756, 1610612772, 17, 33, 17, 1, 17, 34, 33, 33, 33, 18, 1, 18, 33, 34, 2, 1, 18, 33, 18, 17, 3, 33, 18, 18, 1, 2684354563, 17, 17, 17, 34, 33, 26, 27, 27, 3221225498, 17, 33, 33, 18, 2, 34, 2, 18, 17, 33, 1610612741, 1610612756, 1610612756, 1610612756, 1610612772, 2, 1, 33, 18, 18, 34, 2, 17, 17, 17, 17, 18, 34, 33, 33, 17, 2, 33, 1, 2, 3221225509, 3221225508, 3221225508, 3221225508, 3221225508, 1610612773, 2, 18, 33, 33, 1, 26, 27, 27, 3221225498, 33, 2, 17, 34, 33, 1, 1, 2, 1, 33, 1610612740, 1610612756, 1610612756, 1610612756, 1610612772, 17, 34, 18, 18, 2, 17, 17, 2, 34, 17, 2, 17, 34, 18, 34, 17, 34, 34, 2, 2, 25, 3221225492, 3221225492, 3221225492, 3221225492, 37, 17, 34, 1, 17, 1, 26, 27, 27, 3221225498, 2, 17, 2, 34, 33, 34, 18, 33, 1, 34, 1610612739, 1610612755, 1610612771, 2684354597, 37, 3221225475, 1, 34, 1, 33, 34, 1, 17, 34, 33, 18, 1, 1, 33, 33, 1, 17, 2, 34, 33, 3221225493, 3221225492, 3221225492, 3221225492, 3221225492, 3221225507, 18, 2, 17, 34, 34, 26, 27, 27, 3221225498, 18, 17, 33, 1, 18, 18, 17, 17, 17, 18, 2, 34, 2, 18, 34, 34, 2, 17, 34, 18, 17, 17, 17, 17, 33, 33, 17, 33, 33, 17, 2, 34, 33, 33, 17, 3221225493, 3221225474, 3221225477, 3221225492, 3221225492, 3221225491, 2, 17, 18, 17, 34, 26, 27, 27, 3221225498, 2, 2, 17, 33, 34, 17, 33, 34, 17, 17, 1, 17, 18, 17, 1, 17, 2, 17, 2, 34, 18, 34, 18, 2, 18, 33, 34, 18, 18, 2, 17, 34, 18, 34, 34, 2684354597, 37, 3221225523, 3221225477, 3221225476, 3221225475, 1, 34, 18, 34, 2, 26, 27, 27, 3221225498, 2, 17, 18, 18, 17, 2, 33, 34, 17, 33, 1, 33, 17, 2, 33, 34, 1, 17, 18, 34, 1, 33, 2, 18, 2, 17, 17, 33, 2, 34, 2, 33, 34, 34, 17, 34, 2, 17, 1, 2, 34, 33, 18, 33, 2, 18, 26, 27, 27, 3221225498, 17, 34, 18, 33, 34, 2, 17, 1, 17, 34, 1, 2, 2, 17, 17, 34, 1, 18, 1, 33, 1, 1, 33, 17, 18, 1, 34, 34, 34, 18, 1, 18, 1, 1, 33, 17, 17, 1, 17, 33, 17, 17, 34, 34, 33, 2, 26, 27, 27, 3221225498, 33, 1, 17, 2, 34, 33, 17, 33, 33, 33, 18, 34, 18, 17, 34, 18, 18, 33, 1, 18, 34, 2, 17, 17, 34, 33, 18, 33, 2, 1, 34, 17, 1, 17, 33, 17, 34, 2, 33, 34, 17, 34, 34, 2, 33, 18, 26, 27, 27, 3221225498, 18, 18, 1, 18, 1, 1, 34, 34, 34, 1, 18, 18, 34, 17, 17, 17, 34, 2, 17, 1, 1, 2, 1, 17, 18, 1, 2, 34, 1, 34, 18, 1, 1, 17, 17, 1, 1, 18, 33, 1, 18, 17, 17, 2, 33, 34, 26, 27, 27, 3221225498, 17, 18, 1, 33, 33, 34, 1, 18, 2, 33, 1, 2, 18, 17, 33, 18, 34, 33, 34, 17, 18, 33, 34, 2, 34, 1, 17, 17, 33, 17, 34, 18, 33, 1, 1, 17, 17, 2, 34, 2, 18, 17, 33, 33, 18, 17, 26, 27, 27, 3221225498, 34, 17, 18, 2, 18, 1, 17, 1, 1, 2, 1, 1, 2, 1, 1, 2, 2, 18, 17, 1, 1, 17, 17, 33, 34, 33, 2, 33, 34, 2, 17, 1, 33, 34, 18, 2, 34, 33, 2, 34, 2, 2, 34, 52, 53, 54, 26, 27, 27, 3221225498, 1, 34, 17, 33, 33, 1, 2, 33, 1, 34, 2, 18, 2, 34, 17, 33, 18, 18, 33, 33, 18, 18, 34, 18, 33, 33, 33, 2, 2, 17, 34, 1, 1, 18, 1, 17, 17, 34, 34, 33, 2, 17, 1, 68, 69, 70, 26, 27, 27, 3221225498, 2, 33, 18, 34, 2, 34, 2, 34, 17, 18, 18, 1, 2, 33, 1, 18, 17, 18, 33, 17, 34, 17, 17, 18, 1, 17, 33, 1, 1, 2, 34, 33, 33, 18, 1, 18, 33, 33, 34, 34, 18, 2, 17, 68, 69, 70, 26, 27, 27, 3221225498, 18, 18, 2, 18, 2, 33, 2, 2, 34, 33, 33, 17, 17, 18, 18, 2, 17, 34, 18, 1, 1, 1, 1, 2, 34, 1, 17, 34, 2, 33, 1, 17, 33, 17, 2, 33, 34, 17, 33, 34, 17, 17, 1, 68, 69, 70, 26, 27, 12, 3221225498, 52, 53, 54, 17, 34, 17, 1, 17, 33, 17, 1, 34, 18, 34, 34, 34, 18, 18, 33, 34, 2, 17, 1, 1, 2, 17, 1, 18, 33, 2, 2, 2, 34, 17, 34, 2, 34, 1, 34, 1, 18, 33, 1, 68, 69, 70, 26, 27, 12, 3221225498, 68, 69, 70, 34, 34, 33, 34, 2, 33, 1, 34, 34, 17, 18, 18, 34, 33, 34, 33, 33, 2, 34, 18, 1, 1, 1, 18, 18, 2, 17, 17, 34, 2, 17, 1, 18, 18, 17, 33, 33, 18, 1, 2, 68, 69, 70, 26, 27, 12, 3221225498, 68, 69, 70, 34, 2, 33, 2, 2, 33, 1, 34, 33, 17, 1, 2, 17, 1, 34, 18, 1, 17, 18, 2, 1, 1, 33, 1, 34, 34, 18, 2, 33, 1, 17, 18, 1, 2, 1, 2, 33, 34, 17, 1, 68, 69, 70, 26, 27, 27, 3221225498, 68, 69, 70, 33, 34, 34, 17, 2, 2, 34, 2, 1, 34, 33, 34, 33, 34, 2, 18, 18, 17, 2, 17, 17, 2, 2, 34, 33, 34, 2, 1, 18, 1, 17, 33, 1, 18, 17, 1, 1, 17, 1, 33, 68, 69, 70, 26, 27, 27, 3221225498, 68, 69, 70, 1, 33, 18, 34, 17, 1, 1, 33, 17, 1, 2, 34, 34, 1, 34, 34, 1, 34, 18, 34, 18, 34, 1, 1, 18];

    var FlippedHorizontallyFlag = 0x80000000;
    var FlippedVerticallyFlag = 0x40000000;
    var FlippedDiagonallyFlag = 0x20000000;
    var HorizontalFlipDrawFlag = 1;
    var VerticalFlipDrawFlag = 2;
    var DiagonallyFlipDrawFlag = 4;

    var realData = [];

    for (var i = 0; i < tileData.length; i++) {
      var flipAndRotateFlags = 0;
      var tile = tileData[i];
      if ( (tile & FlippedHorizontallyFlag) !== 0 ) {
        flipAndRotateFlags |= HorizontalFlipDrawFlag;
      }
      if ( (tile & FlippedVerticallyFlag) !== 0 ) {
        flipAndRotateFlags |= VerticalFlipDrawFlag;
      }
      if ( (tile & FlippedDiagonallyFlag) !== 0 ) {
        flipAndRotateFlags |= DiagonallyFlipDrawFlag;
      }

      tile &= ~(FlippedHorizontallyFlag |
      FlippedVerticallyFlag |
      FlippedDiagonallyFlag);
      realData.push(tile);
      console.log(i, tile, flipAndRotateFlags);

      if ( (flipAndRotateFlags & HorizontalFlipDrawFlag) !== 0 ) {
        // Flip horizontal
      }
      if ( (flipAndRotateFlags & VerticalFlipDrawFlag) !== 0 ) {
        // Flip vertically
      }
      if ( (flipAndRotateFlags & DiagonallyFlipDrawFlag) !== 0 ) {
        if ( (flipAndRotateFlags & HorizontalFlipDrawFlag) !== 0 &&
          (flipAndRotateFlags & VerticalFlipDrawFlag) !== 0 ) {
          // Rotate 90째
          // Flip vertically
        } else if ( (flipAndRotateFlags & HorizontalFlipDrawFlag) !== 0 ) {
          // Rotate -90째
          // Flip vertically
        } else if ( (flipAndRotateFlags & VerticalFlipDrawFlag) !== 0 ) {
          // Rotate 90째
          // Flip horizontally
        } else {
          // Rotate -90째
          // Flip horizontally
        }
      }
    }*/
  });
};
